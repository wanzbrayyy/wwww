<%- include('../partials/header') %>

<div class="dashboard-wrapper">
    <%- include('../partials/navbar') %>

    <main class="main-content" style="display:flex; flex-direction:column; height:100vh;">
        <header class="top-header" style="flex-shrink:0;">
            <div style="display:flex;align-items:center; gap:10px;">
                <a href="/chat" style="color:white;"><i class="fa-solid fa-arrow-left"></i></a>
                <img src="<%= partner.profile_pic %>" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">
                <div>
                    <div style="font-weight:600; font-size:14px;"><%= partner.username %></div>
                    <div style="font-size:11px; color:#34d399;">Online</div>
                </div>
            </div>
        </header>

        <div class="content-card" style="flex:1; display:flex; flex-direction:column; overflow:hidden; border:none; background:transparent;">
            <div class="card-body" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:15px;" id="chatContainer">
                <% messages.forEach(msg => { %>
                    <div style="display:flex; justify-content: <%= msg.sender.toString() === userId ? 'flex-end' : 'flex-start' %>;">
                        <div style="max-width:75%; background: <%= msg.sender.toString() === userId ? 'var(--neon-blue)' : 'var(--glass-bg)' %>; padding:12px 16px; border-radius:16px; border:1px solid var(--glass-border); color:white;">
                            
                            <div style="font-size:14px; line-height:1.5;">
                                <%= msg.message %>
                            </div>

                            <% if(msg.translations && msg.translations.en && msg.language !== 'en') { %>
                                <div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.15); font-size:13px; color:rgba(255,255,255,0.9); font-style:italic;">
                                    <i class="fa-solid fa-language"></i> EN: <%= msg.translations.en %>
                                </div>
                            <% } %>

                            <div style="font-size:10px; text-align:right; opacity:0.7; margin-top:6px; display:flex; align-items:center; justify-content:flex-end; gap:5px;">
                                <%= moment(msg.createdAt).format('HH:mm') %>
                                <% if(msg.sender.toString() === userId) { %>
                                    <i class="fa-solid fa-check-double" style="color:<%= msg.isRead ? '#34d399' : 'white' %>"></i>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>

            <div style="padding:15px; background:var(--glass-bg); border-top:1px solid var(--glass-border);">
                <form action="/chat/send" method="POST" style="display:flex; gap:10px;">
                    <input type="hidden" name="receiverId" value="<%= partner._id %>">
                    <input type="text" name="message" class="form-control" placeholder="Ketik pesan..." required autocomplete="off" style="border-radius:25px; padding-left:20px;">
                    <button class="btn-primary" style="width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; padding:0;">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </main>
</div>

<script>
    const container = document.getElementById('chatContainer');
    container.scrollTop = container.scrollHeight;
</script>

<%- include('../partials/footer') %>